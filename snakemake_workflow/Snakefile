"""Simple correlation Snakemake workflow.

This workflow demonstrates Snakemake features with a simple pandas-based analysis:
1. Load two datasets from URLs
2. Filter to numerical columns
3. Join the datasets
4. Compute Spearman correlation
5. Generate a clustered heatmap

Usage:
    # Run full workflow
    snakemake --cores 1 -d /path/to/output

    # Run with container (requires apptainer/singularity)
    snakemake --cores 1 --sdm apptainer -d /path/to/output

    # Dry run
    snakemake -n -d /path/to/output

    # Generate report
    snakemake --report report.html -d /path/to/output
"""

from snakemake.utils import min_version

min_version("8.0")


# Base directory (where Snakefile is located)
BASEDIR = workflow.basedir


# Load configuration
configfile: f"{BASEDIR}/config/config.yaml"


# Global report
report: f"{BASEDIR}/report/workflow.rst"


# Container image for all rules (used with --sdm apptainer)
container: config["container"]


# Output directories (relative to working directory set via -d)
DATA_DIR = "data"
RESULTS_DIR = "results"
FIGURES_DIR = "figures"
LOGS_DIR = "logs"


# Default target
rule all:
    input:
        f"{FIGURES_DIR}/correlation_heatmap.png",


# Step 1a: Download meaningful variables data
rule download_meaningful_variables:
    output:
        f"{DATA_DIR}/meaningful_variables.csv",
    params:
        url=config["meaningful_variables_url"],
    log:
        f"{LOGS_DIR}/download_meaningful_variables.log",
    conda:
        f"{BASEDIR}/envs/simple.yml"
    script:
        f"{BASEDIR}/scripts/download_data.py"


# Step 1b: Download demographics data
rule download_demographics:
    output:
        f"{DATA_DIR}/demographics.csv",
    params:
        url=config["demographics_url"],
    log:
        f"{LOGS_DIR}/download_demographics.log",
    conda:
        f"{BASEDIR}/envs/simple.yml"
    script:
        f"{BASEDIR}/scripts/download_data.py"


# Step 2a: Filter meaningful variables to numerical columns
rule filter_meaningful_variables:
    input:
        f"{DATA_DIR}/meaningful_variables.csv",
    output:
        f"{DATA_DIR}/meaningful_variables_numerical.csv",
    log:
        f"{LOGS_DIR}/filter_meaningful_variables.log",
    conda:
        f"{BASEDIR}/envs/simple.yml"
    script:
        f"{BASEDIR}/scripts/filter_data.py"


# Step 2b: Filter demographics to numerical columns
rule filter_demographics:
    input:
        f"{DATA_DIR}/demographics.csv",
    output:
        f"{DATA_DIR}/demographics_numerical.csv",
    log:
        f"{LOGS_DIR}/filter_demographics.log",
    conda:
        f"{BASEDIR}/envs/simple.yml"
    script:
        f"{BASEDIR}/scripts/filter_data.py"


# Step 3: Join the two datasets
rule join_datasets:
    input:
        meaningful_vars=f"{DATA_DIR}/meaningful_variables_numerical.csv",
        demographics=f"{DATA_DIR}/demographics_numerical.csv",
    output:
        f"{DATA_DIR}/joined_data.csv",
    log:
        f"{LOGS_DIR}/join_datasets.log",
    conda:
        f"{BASEDIR}/envs/simple.yml"
    script:
        f"{BASEDIR}/scripts/join_data.py"


# Step 4: Compute correlation matrix
rule compute_correlation:
    input:
        f"{DATA_DIR}/joined_data.csv",
    output:
        f"{RESULTS_DIR}/correlation_matrix.csv",
    params:
        method=config["correlation_method"],
    log:
        f"{LOGS_DIR}/compute_correlation.log",
    conda:
        f"{BASEDIR}/envs/simple.yml"
    script:
        f"{BASEDIR}/scripts/compute_correlation.py"


# Step 5: Generate clustered heatmap
rule generate_heatmap:
    input:
        f"{RESULTS_DIR}/correlation_matrix.csv",
    output:
        report(
            f"{FIGURES_DIR}/correlation_heatmap.png",
            caption=f"{BASEDIR}/report/heatmap.rst",
            category="Results",
        ),
    params:
        figsize=config["heatmap"]["figsize"],
        cmap=config["heatmap"]["cmap"],
        vmin=config["heatmap"]["vmin"],
        vmax=config["heatmap"]["vmax"],
    log:
        f"{LOGS_DIR}/generate_heatmap.log",
    conda:
        f"{BASEDIR}/envs/simple.yml"
    script:
        f"{BASEDIR}/scripts/generate_heatmap.py"
